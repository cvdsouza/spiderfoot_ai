# SpiderFoot scan worker services — STATELESS (Phase 12)
#
# Workers execute scans and publish results to RabbitMQ. The API server
# consumes results from RabbitMQ and writes them to the database.
#
# Workers do NOT require direct database access or shared filesystem (NFS).
# They only need:
#   - RabbitMQ connection (RABBITMQ_URL)
#   - CA certificate for TLS (RABBITMQ_CA_CERT_HOST)
#   - API server URL for heartbeats (SPIDERFOOT_API_URL)
#
# Works in two modes (selected automatically by worker/start.sh):
#
#   LOCAL  — parent directory contains docker-compose.yml.
#            Workers are merged into the same Compose project as the API server.
#
#   REMOTE — standalone deployment on a separate machine.
#            Set RABBITMQ_CA_CERT_HOST to the host path of the CA certificate
#            copied from the API server (certs/ca.crt).
#
# Do not edit env var values here — use your .env file.

services:
  sf-worker-fast:
    build:
      context: .
      dockerfile: Dockerfile
    image: spiderfoot
    command: ["worker.py", "--queue", "fast", "--concurrency", "${WORKER_FAST_CONCURRENCY:-2}"]
    volumes:
      # CA certificate for RabbitMQ TLS verification.
      # Default ../certs/ca.crt works for local deployments.
      # Set RABBITMQ_CA_CERT_HOST=/host/path/ca.crt for remote deployments.
      - "${RABBITMQ_CA_CERT_HOST:-../certs/ca.crt}:/etc/rabbitmq/certs/ca.crt:ro"
    environment:
      RABBITMQ_URL: "${RABBITMQ_URL:-amqps://spiderfoot:spiderfoot@rabbitmq:5671/}"
      RABBITMQ_CA_CERT: "/etc/rabbitmq/certs/ca.crt"
      SPIDERFOOT_WORKER_NAME: "${SPIDERFOOT_WORKER_NAME:-worker-fast-1}"
      SPIDERFOOT_API_URL: "${SPIDERFOOT_API_URL:-http://spiderfoot:5001}"
    restart: unless-stopped

  sf-worker-slow:
    build:
      context: .
      dockerfile: Dockerfile
    image: spiderfoot
    command: ["worker.py", "--queue", "slow", "--concurrency", "${WORKER_SLOW_CONCURRENCY:-1}"]
    volumes:
      # CA certificate for RabbitMQ TLS verification.
      # Default ../certs/ca.crt works for local deployments.
      # Set RABBITMQ_CA_CERT_HOST=/host/path/ca.crt for remote deployments.
      - "${RABBITMQ_CA_CERT_HOST:-../certs/ca.crt}:/etc/rabbitmq/certs/ca.crt:ro"
    environment:
      RABBITMQ_URL: "${RABBITMQ_URL:-amqps://spiderfoot:spiderfoot@rabbitmq:5671/}"
      RABBITMQ_CA_CERT: "/etc/rabbitmq/certs/ca.crt"
      SPIDERFOOT_WORKER_NAME: "${SPIDERFOOT_WORKER_NAME:-worker-slow-1}"
      SPIDERFOOT_API_URL: "${SPIDERFOOT_API_URL:-http://spiderfoot:5001}"
    restart: unless-stopped
