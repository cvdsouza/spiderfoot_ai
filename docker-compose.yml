version: "3"

# Basic usage:
#     $ ./start.sh
#
# Dev environment (code directory mapped into container):
#     $ docker-compose -f docker-compose.yml -f docker-compose-dev.yml up
#
# Full image (all CLI tools installed):
#     $ docker-compose -f docker-compose.yml -f docker-compose-full.yml up
#
# With distributed workers (Phase 11):
#     $ ./start-worker.sh --fast 2 --slow 1 --detach
#
# Spiderfoot data resides in a Docker volume:
#     /var/lib/docker/volumes/spiderfoot_spiderfoot-data/_data/spiderfoot.db
#
# TLS certificates are generated automatically by ./start.sh and stored in certs/.
# RabbitMQ only accepts encrypted AMQPS connections (port 5671).

services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: sf-rabbitmq
    ports:
      - "5671:5671"    # AMQPS (TLS) — used by API server and workers
      - "15672:15672"  # Management UI — http://localhost:15672 (restrict in production)
    environment:
      RABBITMQ_DEFAULT_USER: "${RABBITMQ_USER:-spiderfoot}"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASS:-spiderfoot}"
    volumes:
      # TLS certificates (generated by ./generate-certs.sh / ./start.sh)
      - ./certs:/etc/rabbitmq/certs:ro
      # TLS-only broker configuration
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      # Persistent queue data
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      # rabbitmq-diagnostics ping uses the internal Erlang protocol, not AMQP,
      # so it works even when the plain TCP listener is disabled.
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  spiderfoot:
    build:
      context: ./
    volumes:
      - spiderfoot-data:/var/lib/spiderfoot
      # CA certificate so the API server can verify the broker's TLS cert
      - ./certs/ca.crt:/etc/rabbitmq/certs/ca.crt:ro
    image: spiderfoot
    container_name: spiderfoot
    ports:
      - "5001:5001"
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      # Admin credentials — set in .env before first run.
      # The admin user is created once on first startup; use the UI to change after that.
      SPIDERFOOT_ADMIN_USER: "${SPIDERFOOT_ADMIN_USER:-admin}"
      SPIDERFOOT_ADMIN_PASSWORD: "${SPIDERFOOT_ADMIN_PASSWORD:-changeme}"
      # RabbitMQ — AMQPS (TLS) connection. Set in .env to override.
      # Workers consume from these queues; scans fall back to local subprocess if unset.
      RABBITMQ_URL: "${RABBITMQ_URL:-amqps://spiderfoot:spiderfoot@rabbitmq:5671/}"
      # Path to CA certificate for broker TLS verification
      RABBITMQ_CA_CERT: "/etc/rabbitmq/certs/ca.crt"

volumes:
  spiderfoot-data:
  rabbitmq-data:
